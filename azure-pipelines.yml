name: azure

trigger:
  - main
pr:
  - main

variables:
  - group: nctdev-vars
  - name: CI
    value: 'true'
  - ${{ if eq(variables['Build.Reason'], 'PullRequest') }}:
    - name: NX_BRANCH
      value: $(System.PullRequest.PullRequestNumber)
    - name: TARGET_BRANCH
      value: $[replace(variables['System.PullRequest.TargetBranch'],'refs/heads/','origin/')]
    - name: BASE_SHA
      value: $(git merge-base $(TARGET_BRANCH) HEAD)
  - ${{ if ne(variables['Build.Reason'], 'PullRequest') }}:
    - name: NX_BRANCH
      value: $(Build.SourceBranchName)
    - name: BASE_SHA
      value: $(git rev-parse HEAD~1)
  - name: HEAD_SHA
    value: $(git rev-parse HEAD)
  - name: NX_CLOUD_ACCESS_TOKEN
    value: $(NX_CLOUD_ACCESS_TOKEN)




jobs:
  - job: main
    pool:
      vmImage: 'ubuntu-latest'
    steps:
      - checkout: self
        fetchDepth: '0'
        fetchFilter: tree:0
      # Set Azure Devops CLI default settings
      - bash: az devops configure --defaults organization=$(System.TeamFoundationCollectionUri) project=$(System.TeamProject)
        displayName: 'Set default Azure DevOps organization and project'
      # Get last successfull commit from Azure Devops CLI
      - bash: |
          LAST_SHA=$(az pipelines build list --branch $(Build.SourceBranchName) --definition-ids $(System.DefinitionId) --result succeeded --top 1 --query "[0].triggerInfo.\"ci.sourceSha\"")
          if [ -z "$LAST_SHA" ]
          then
            echo "Last successful commit not found. Using fallback 'HEAD~1': $BASE_SHA"
          else
            echo "Last successful commit SHA: $LAST_SHA"
            echo "##vso[task.setvariable variable=BASE_SHA]$LAST_SHA"
          fi
        displayName: 'Get last successful commit SHA'
        condition: ne(variables['Build.Reason'], 'PullRequest')
        env:
          AZURE_DEVOPS_EXT_PAT: $(System.AccessToken)

      # This enables task distribution via Nx Cloud
      # Run this command as early as possible, before dependencies are installed
      # Learn more at https://nx.dev/ci/reference/nx-cloud-cli#npx-nxcloud-startcirun
      # Uncomment this line to enable task distribution
      # - script: npx nx start-ci-run --distribute-on="3 linux-medium-js" --stop-agents-after="build"

      # Set up Node.js with caching
      - task: NodeTool@0
        inputs:
          versionSpec: '20.x'
        displayName: 'Install Node.js'

      - task: Cache@2
        inputs:
          key: 'npm | "$(Agent.OS)" | package-lock.json'
          path: $(npm config get cache)
          restoreKeys: |
            npm | "$(Agent.OS)"
        displayName: 'Cache npm'

      - script: npm ci
        displayName: 'Install dependencies'
      - script: git branch --track main origin/main
        condition: eq(variables['Build.Reason'], 'PullRequest')
        displayName: 'Track main branch for PRs'

      # Prepend any command with "nx-cloud record --" to record its logs to Nx Cloud
      # - script: npx nx-cloud record -- echo Hello World

      - script: npx nx-cloud record -- npx nx format:check --base=$(BASE_SHA)
        displayName: 'Check formatting'

      - script: npx nx affected --base=$(BASE_SHA) --head=$(HEAD_SHA) -t lint test build typecheck
        displayName: 'Run affected tasks'

      # Nx Cloud recommends fixes for failures to help you get CI green faster. Learn more: https://nx.dev/ci/features/self-healing-ci
      - script: npx nx fix-ci
        displayName: 'Fix CI issues'
        condition: always()
